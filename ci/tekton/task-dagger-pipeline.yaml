apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: dagger-pipeline
  namespace: tekton-pipelines
  labels:
    lornu.ai/component: tekton
    lornu.ai/managed-by: cdk8s
    app.kubernetes.io/part-of: lornu-ai
  annotations:
    tekton.dev/displayName: Dagger Pipeline Task
spec:
  description: Runs the Dagger CI pipeline for lornu.ai based on branch pattern
  params:
    - name: branch
      type: string
      description: Git branch name
    - name: event
      type: string
      description: Git event type (push, pull_request, merge)
      default: push
    - name: base-branch
      type: string
      description: Base branch for PR events
      default: ""
  workspaces:
    - name: source
      description: The git repo source code
  steps:
    - name: install-dependencies
      image: oven/bun:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash
        set -e
        echo "ğŸ“¦ Installing dependencies..."
        bun install
        echo "âœ… Dependencies installed"
    - name: run-dagger-pipeline
      image: ghcr.io/dagger/dagger:latest
      workingDir: $(workspaces.source.path)
      env:
        - name: DAGGER_LOG_FORMAT
          value: plain
        - name: DAGGER_LOG_LEVEL
          value: info
      script: |
        #!/bin/bash
        set -e

        BRANCH="$(params.branch)"
        EVENT="$(params.event)"
        BASE_BRANCH="$(params.base-branch)"

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” Branch: $BRANCH"
        echo "ğŸ” Event: $EVENT"
        echo "ğŸ” Base Branch: $BASE_BRANCH"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # Determine branch pattern
        if [[ "$BRANCH" == feat/* ]]; then
          PATTERN="feat"
        elif [[ "$BRANCH" == infra/* ]]; then
          PATTERN="infra"
        elif [[ "$BRANCH" == agent/* ]]; then
          PATTERN="agent"
        elif [[ "$BRANCH" == "ta" ]]; then
          PATTERN="trunk"
        else
          PATTERN="unknown"
        fi

        echo "ğŸ” Pattern: $PATTERN"

        # Run Dagger pipeline
        bun ci/dagger.ts \
          --branch "$BRANCH" \
          --event "$EVENT" \
          --base-branch "$BASE_BRANCH"

        echo "âœ… Dagger pipeline completed!"
